#!/usr/bin/env bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞ –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞

set -e

echo "üîÑ –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –ø—Ä–æ–µ–∫—Ç–∞ Researcherry..."

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd "$(dirname "$0")"

# –£–¥–∞–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é vscode, –µ—Å–ª–∏ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ -d "vscode" ]; then
    echo "üóëÔ∏è  –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é vscode..."
    rm -rf vscode
fi

# –£–¥–∞–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–±–æ—Ä–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
echo "üßπ –û—á–∏—â–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–±–æ—Ä–∫–∏..."
rm -rf VSCode-*
rm -rf .build

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ –ø–∞—Ç—á–∏
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ç—á–∏ –Ω–∞ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è..."

PATCHES_DIR="patches"
CORRUPTED_PATCHES=()

for patch_file in "$PATCHES_DIR"/*.patch; do
    if [ -f "$patch_file" ]; then
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω –ª–∏ –ø–∞—Ç—á
        if ! git apply --check --ignore-whitespace "$patch_file" 2>/dev/null; then
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ñ–æ—Ä–º–∞—Ç–∞
            if grep -q "^diff --git" "$patch_file" && grep -q "^@@" "$patch_file"; then
                echo "‚ö†Ô∏è  –ü–∞—Ç—á –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã: $(basename "$patch_file")"
            else
                echo "‚ùå –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–π –ø–∞—Ç—á: $(basename "$patch_file")"
                CORRUPTED_PATCHES+=("$patch_file")
            fi
        else
            echo "‚úÖ –ü–∞—Ç—á –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω: $(basename "$patch_file")"
        fi
    fi
done

# –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã—Ö –ø–∞—Ç—á–µ–π
if [ ${#CORRUPTED_PATCHES[@]} -gt 0 ]; then
    echo "üíæ –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã—Ö –ø–∞—Ç—á–µ–π..."
    mkdir -p patches/backup
    for patch in "${CORRUPTED_PATCHES[@]}"; do
        cp "$patch" "patches/backup/$(basename "$patch").backup"
        echo "   –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è: patches/backup/$(basename "$patch").backup"
    done
fi

echo ""
echo "‚úÖ –°–±—Ä–æ—Å –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo ""
echo "–¢–µ–ø–µ—Ä—å –∑–∞–ø—É—Å—Ç–∏—Ç–µ:"
echo "  ./prepare_vscode.sh  # –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —á–∏—Å—Ç–æ–≥–æ VSCode –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ç—á–µ–π"
echo ""
echo "–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–∞—Ç—á–∞–º–∏ –æ—Å—Ç–∞—é—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é patches/backup/"
