#!/usr/bin/env bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° dev-ÑÐµÑ€Ð²ÐµÑ€Ð° VS Code Ñ Ð½Ð°ÑˆÐ¸Ð¼Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸ÑÐ¼Ð¸
# ÐžÐ±Ñ…Ð¾Ð´Ð¸Ñ‚ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ ÑÐ¾ ÑÐ±Ð¾Ñ€ÐºÐ¾Ð¹, Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ Ð² Ñ€ÐµÐ¶Ð¸Ð¼Ðµ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸

set -e

echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº dev-ÑÐµÑ€Ð²ÐµÑ€Ð° VS Code Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸ÑÐ¼Ð¸ Welcome Screen..."

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° PATH Ð´Ð»Ñ Node.js
if [ -d "/opt/homebrew/opt/node@22/bin" ]; then
    export PATH="/opt/homebrew/opt/node@22/bin:$PATH"
    echo "âœ… Node.js: $(node --version)"
fi

WELCOME_FILE="vscode/src/vs/workbench/contrib/welcomeGettingStarted/common/gettingStartedContent.ts"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹
if grep -q "ResearcherryAI" "$WELCOME_FILE"; then
    echo "âœ… Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ ResearcherryAI Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ Ð² Ð¸ÑÑ…Ð¾Ð´Ð½Ð¾Ð¼ Ñ„Ð°Ð¹Ð»Ðµ"
else
    echo "âŒ Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹! ÐŸÑ€Ð¸Ð¼ÐµÐ½ÑÐµÐ¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ..."
    # Ð—Ð´ÐµÑÑŒ Ð¼Ð¾Ð¶Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð»Ð¾Ð³Ð¸ÐºÑƒ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹
fi

cd vscode

echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ (ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾)..."
if [ ! -d "node_modules" ]; then
    npm ci
fi

echo "ðŸ”¨ ÐšÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ñ Ð¸ÑÑ…Ð¾Ð´Ð½Ð¸ÐºÐ¾Ð²..."
if npm run compile; then
    echo "âœ… ÐšÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ñ ÑƒÑÐ¿ÐµÑˆÐ½Ð°"
else
    echo "âš ï¸  ÐžÑˆÐ¸Ð±ÐºÐ° ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ð¸, Ð½Ð¾ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÐµÐ¼..."
fi

echo "ðŸŒ Ð—Ð°Ð¿ÑƒÑÐº dev-ÑÐµÑ€Ð²ÐµÑ€Ð°..."
echo "ðŸ’¡ ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð¾Ñ‚ÐºÑ€Ð¾ÐµÑ‚ÑÑ Ð² Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ðµ Ð½Ð° http://localhost:8080"
echo "â¹ï¸  Ð”Ð»Ñ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ Ctrl+C"

# Ð—Ð°Ð¿ÑƒÑÐº Ð² Ñ€ÐµÐ¶Ð¸Ð¼Ðµ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸
npm run watch &
WATCH_PID=$!

sleep 5

# Ð—Ð°Ð¿ÑƒÑÐº web-ÑÐµÑ€Ð²ÐµÑ€Ð°
npm run serve-web &
SERVE_PID=$!

echo "ðŸŽ‰ Dev-ÑÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½!"
echo "ðŸ“± ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ http://localhost:8080 Ð² Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ðµ"
echo "ðŸ”„ Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð±ÑƒÐ´ÑƒÑ‚ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÑÑ‚ÑŒÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸"

# ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ
wait $SERVE_PID

# ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð²
kill $WATCH_PID 2>/dev/null || true
